---
phase: 03-upload-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/upload-zone.tsx
  - src/lib/image-utils.ts
  - src/app/page.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "Designer can drag an image file onto the upload zone and it is accepted"
    - "Designer can click the upload zone to open a file picker"
    - "Dropping a PDF or GIF shows an error message (only PNG, JPG, WebP accepted)"
    - "Dropping a file over 10MB shows a clear error message"
    - "Uploaded image is automatically compressed/resized to max 2000px"
    - "Designer sees a preview of the uploaded image with file info"
    - "Designer can remove the uploaded image and start over"
  artifacts:
    - path: "src/components/upload-zone.tsx"
      provides: "Drag-and-drop upload component with validation and preview"
    - path: "src/lib/image-utils.ts"
      provides: "Image compression and validation utilities"
    - path: "src/app/page.tsx"
      provides: "Updated home page with upload zone"
  key_links:
    - from: "src/components/upload-zone.tsx"
      to: "src/lib/image-utils.ts"
      via: "import compressImage"
      pattern: "import.*image-utils"
    - from: "src/app/page.tsx"
      to: "src/components/upload-zone.tsx"
      via: "import UploadZone"
      pattern: "import.*upload-zone"
---

<objective>
Build the image upload system with drag-and-drop, file validation, client-side compression, and preview.

Purpose: This is the input side of the core loop — designers need a frictionless way to get their screenshots into the tool. Upload must feel instant and handle edge cases gracefully.
Output: Working upload zone on the home page with validation, compression, and preview.
</objective>

<execution_context>
@/Users/georgebagaoisan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/georgebagaoisan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-upload-system/03-RESEARCH.md
@.planning/research/ARCHITECTURE.md
@src/types/critique.ts
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone and create image utilities</name>
  <files>
    package.json
    src/lib/image-utils.ts
  </files>
  <action>
    1. Install: `npm install react-dropzone`

    2. Create `src/lib/image-utils.ts` with two exports:

    **`compressImage(file: File, maxDimension?: number): Promise<{ base64: string; mediaType: string }>`**
    - Default maxDimension: 2000
    - Load the file into an Image element via `URL.createObjectURL`
    - If either dimension exceeds maxDimension, scale down proportionally
    - Draw onto a canvas at the new dimensions
    - Output as the original MIME type (preserve PNG for transparency, JPEG for photos, WebP as-is)
    - For JPEG output, use quality 0.85
    - Convert canvas to data URL, extract pure base64 (split on comma)
    - Clean up with `URL.revokeObjectURL` to prevent memory leaks
    - Return `{ base64, mediaType }` where mediaType is 'image/png' | 'image/jpeg' | 'image/webp'

    **`formatFileSize(bytes: number): string`**
    - Return human-readable size: "1.2 MB", "450 KB", etc.
    - Use KB for <1MB, MB for >=1MB

    Types to use from `@/types/critique`: reference `CritiqueRequest['mediaType']` for the allowed media types.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm ls react-dropzone` — confirms installation.
  </verify>
  <done>
    react-dropzone installed. Image utilities provide compressImage (canvas-based resize + base64 conversion) and formatFileSize helper.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create upload zone component and update page</name>
  <files>
    src/components/upload-zone.tsx
    src/app/page.tsx
  </files>
  <action>
    1. Create `src/components/upload-zone.tsx` — "use client" component:

    Props interface:
    ```typescript
    interface UploadZoneProps {
      onImageReady: (data: { base64: string; mediaType: string; fileName: string; originalSize: number; compressedSize: number }) => void;
      onImageRemove: () => void;
      imagePreview: string | null;  // data URL for preview
    }
    ```

    Implementation:
    - Use `useDropzone` from react-dropzone with:
      - `accept: { 'image/png': ['.png'], 'image/jpeg': ['.jpg', '.jpeg'], 'image/webp': ['.webp'] }`
      - `maxSize: 10 * 1024 * 1024` (10MB)
      - `multiple: false`
      - `onDrop` callback
    - **Idle state**: Dashed border zone with upload icon (use a simple SVG or emoji), "Drag & drop your UI screenshot here" text, "or click to browse" subtitle, show accepted formats "PNG, JPG, or WebP — max 10MB"
    - **Drag-over state**: Highlighted border (blue/primary color), "Drop your image here" text
    - **Error state**: Show rejection reason inline (wrong format or too large) with red text, auto-clear after 5 seconds
    - **Processing state**: Brief "Compressing..." indicator while canvas processes
    - **Preview state**: Show the uploaded image preview, file name, original dimensions/size, "Remove" button to clear
    - On valid drop: call `compressImage()` from image-utils, then call `onImageReady` with results
    - Store preview URL in local state via `URL.createObjectURL` for the preview image
    - Use ShadCN Card for the container, Button for "Remove"
    - Style with Tailwind: rounded border, dashed when idle, solid when preview, transition states

    2. Update `src/app/page.tsx`:
    - Keep as server component wrapper, but import the upload zone
    - Create a client component wrapper (or make page.tsx "use client") that manages state:
      - `uploadedImage: { base64: string; mediaType: string; fileName: string } | null`
    - Replace the placeholder Card content with UploadZone
    - Keep the DesignCritic heading and subtitle
    - Layout: centered single column, max-w-2xl
    - When image is uploaded, show the preview within the upload zone
    - No submit button or API call yet — just upload and preview (Phase 4/5 will add the full flow)
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run dev` and test in browser:
    - Drag a PNG onto the zone → should show preview
    - Click the zone → file picker opens, select JPG → shows preview
    - Drag a PDF → should show format error
    - Drag a 15MB+ file → should show size error
    - Click "Remove" → clears preview, returns to idle state
  </verify>
  <done>
    Upload zone renders on the home page with drag-and-drop + click support, format/size validation, client-side compression, and image preview with remove.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Upload system with drag-and-drop, validation, compression, and preview on the home page.
  </what-built>
  <how-to-verify>
    1. Visit http://localhost:3000
    2. You should see the DesignCritic heading with an upload zone below
    3. **Drag-and-drop test**: Drag any PNG/JPG screenshot onto the zone — should compress and show preview
    4. **Click test**: Click the zone — file picker should open
    5. **Format rejection**: Try dragging a PDF or GIF — should show error
    6. **Size rejection**: If you have a file >10MB, try it — should show error
    7. **Preview**: After uploading, you should see the image preview with file info
    8. **Remove**: Click Remove/clear — should return to the upload zone
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Drag-and-drop accepts PNG, JPG, WebP
3. Click-to-browse opens file picker
4. PDF/GIF/other formats show error
5. Files >10MB show error
6. Images are compressed to max 2000px before base64 conversion
7. Preview displays uploaded image with file info
8. Remove button clears the upload and returns to idle state
</verification>

<success_criteria>
- Drag-and-drop and click-to-browse both work
- Only PNG, JPG, WebP accepted (others show error)
- Files over 10MB rejected with clear message
- Images automatically compressed/resized to max 2000px
- Preview shows uploaded image
- Remove button clears state
</success_criteria>

<output>
After completion, create `.planning/phases/03-upload-system/03-01-SUMMARY.md`
</output>

---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - src/app/api/critique/route.ts
  - src/lib/claude.ts
  - .env.local
  - .env.example
  - package.json
autonomous: false
user_setup:
  - service: anthropic
    why: "Claude API for AI design critiques"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console (console.anthropic.com) -> API Keys -> Create Key"

must_haves:
  truths:
    - "POST /api/critique returns a valid mock critique response"
    - "ANTHROPIC_API_KEY is loaded server-side only and never exposed to client"
    - "Claude client wrapper initializes without errors when API key is present"
    - "API route validates request body and returns 400 for invalid input"
  artifacts:
    - path: "src/app/api/critique/route.ts"
      provides: "POST endpoint for design critique"
      exports: ["POST"]
    - path: "src/lib/claude.ts"
      provides: "Claude API client wrapper"
    - path: ".env.local"
      provides: "API key configuration"
      contains: "ANTHROPIC_API_KEY"
    - path: ".env.example"
      provides: "Environment variable template for collaborators"
  key_links:
    - from: "src/app/api/critique/route.ts"
      to: "src/lib/claude.ts"
      via: "import"
      pattern: "import.*claude"
    - from: "src/lib/claude.ts"
      to: "process.env.ANTHROPIC_API_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.ANTHROPIC_API_KEY"
    - from: "src/app/api/critique/route.ts"
      to: "src/types/critique.ts"
      via: "import types"
      pattern: "import.*types/critique"
---

<objective>
Set up the Claude API integration layer with environment config and a stub API route.

Purpose: Prove the API route → Claude client pattern works end-to-end, with the API key securely stored server-side. The stub returns mock data now; Phase 2 replaces it with real Claude calls.
Output: Working /api/critique POST endpoint, Claude client wrapper, and environment configuration.
</objective>

<execution_context>
@/Users/georgebagaoisan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/georgebagaoisan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Claude SDK + Zod, configure environment</name>
  <files>
    package.json
    .env.local
    .env.example
  </files>
  <action>
    1. Install dependencies: `npm install @anthropic-ai/sdk zod`

    2. Create `.env.local` at project root with:
       ```
       ANTHROPIC_API_KEY=your-api-key-here
       ```
       CRITICAL: Do NOT use `NEXT_PUBLIC_` prefix — this would expose the key to the client bundle.

    3. Create `.env.example` at project root (committed to git, serves as template):
       ```
       # Get your API key from https://console.anthropic.com
       ANTHROPIC_API_KEY=
       ```

    4. Verify `.env.local` is in `.gitignore` (Next.js adds it by default, but confirm).
  </action>
  <verify>
    Run `npm ls @anthropic-ai/sdk zod` to confirm both packages are installed.
    Confirm `.env.local` exists and is listed in `.gitignore`.
    Confirm `.env.example` exists and does NOT contain any actual key value.
  </verify>
  <done>
    @anthropic-ai/sdk and zod are installed. Environment variables configured with .env.local (gitignored) and .env.example (committed template).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Claude client wrapper and stub API route</name>
  <files>
    src/lib/claude.ts
    src/app/api/critique/route.ts
  </files>
  <action>
    1. Create `src/lib/claude.ts` — Claude API client wrapper:
       ```typescript
       import Anthropic from '@anthropic-ai/sdk';

       // Singleton Claude client — server-side only
       // In Phase 2, this module will add the critique function with tool_use
       export function getClaudeClient(): Anthropic {
         const apiKey = process.env.ANTHROPIC_API_KEY;
         if (!apiKey) {
           throw new Error('ANTHROPIC_API_KEY environment variable is not set');
         }
         return new Anthropic({ apiKey });
       }
       ```

    2. Create `src/app/api/critique/route.ts` — POST endpoint:
       ```typescript
       import { NextRequest, NextResponse } from 'next/server';
       import { z } from 'zod';
       import { getClaudeClient } from '@/lib/claude';
       import type { CritiqueResponse, CritiqueError } from '@/types/critique';

       const critiqueRequestSchema = z.object({
         image: z.string().min(1),
         mediaType: z.enum(['image/png', 'image/jpeg', 'image/webp']),
         context: z.enum(['saas', 'healthcare', 'consumer', 'ecommerce', 'fintech']),
         tone: z.enum(['constructive', 'roast']),
       });

       export async function POST(request: NextRequest) {
         try {
           const body = await request.json();
           const parsed = critiqueRequestSchema.safeParse(body);

           if (!parsed.success) {
             return NextResponse.json(
               { error: 'Invalid request: ' + parsed.error.issues.map(i => i.message).join(', ') } satisfies CritiqueError,
               { status: 400 }
             );
           }

           // Verify Claude client can initialize (proves API key is configured)
           getClaudeClient();

           // Phase 2 replaces this mock with real Claude API call
           const mockCritique: CritiqueResponse = {
             critique: {
               what_works: [
                 { summary: 'Clean visual hierarchy guides the eye naturally.', detail: 'The layout uses a clear top-down flow with appropriate spacing between sections, making it easy to scan.' },
               ],
               usability_risks: [
                 { summary: 'Primary CTA lacks visual prominence.', detail: 'The main call-to-action button blends with surrounding elements. Consider increasing contrast or size to improve click-through rate.' },
               ],
               visual_hierarchy: [
                 { summary: 'Typography scale needs more contrast between levels.', detail: 'The difference between H1 and H2 sizes is too subtle, making it harder to distinguish content sections at a glance.' },
               ],
               improvements: [
                 { summary: 'Add whitespace between form fields.', detail: 'Increasing vertical spacing between input fields by 8-12px would reduce visual clutter and improve readability.' },
               ],
             },
           };

           return NextResponse.json(mockCritique);
         } catch (error) {
           return NextResponse.json(
             { error: 'Internal server error' } satisfies CritiqueError,
             { status: 500 }
           );
         }
       }
       ```

       Key decisions:
       - Zod validation on request body (rejects bad input with 400)
       - Calls `getClaudeClient()` to verify API key exists (but doesn't make a real call yet)
       - Returns realistic mock data matching the CritiqueResult type shape
       - Phase 2 will replace the mock section with actual Claude API call using tool_use
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run dev`, then test with:
    ```bash
    curl -X POST http://localhost:3000/api/critique \
      -H "Content-Type: application/json" \
      -d '{"image":"dGVzdA==","mediaType":"image/png","context":"saas","tone":"constructive"}'
    ```
    Should return 200 with mock critique JSON.

    Test validation with invalid body:
    ```bash
    curl -X POST http://localhost:3000/api/critique \
      -H "Content-Type: application/json" \
      -d '{"image":""}'
    ```
    Should return 400 with error message.
  </verify>
  <done>
    POST /api/critique returns mock critique data with Zod validation. Claude client wrapper verifies API key is present. Types from critique.ts are used throughout. No API key exposure to client.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Foundation is complete: Next.js app with ShadCN, Claude API client, and /api/critique stub endpoint.
  </what-built>
  <how-to-verify>
    1. Visit http://localhost:3000 — you should see the DesignCritic placeholder page with styled card
    2. Open browser DevTools → Sources/Network — confirm no ANTHROPIC_API_KEY appears in any client-side code
    3. The curl test above should return mock critique JSON
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts with no errors
2. `npx tsc --noEmit` passes
3. POST /api/critique with valid body returns 200 + mock critique JSON
4. POST /api/critique with invalid body returns 400 + error message
5. ANTHROPIC_API_KEY is not in any client-side bundle (check page source / network tab)
6. `.env.local` is gitignored, `.env.example` is committed
</verification>

<success_criteria>
- Claude SDK and Zod installed and importable
- Environment variables configured securely (server-side only)
- /api/critique POST endpoint validates input and returns mock critique
- Claude client wrapper initializes successfully with API key
- No API key leakage to client-side code
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
